from util import calibrate_time
import numpy

CVE_FILE = 'cve_list.txt'
MALWARE_FILE = 'malware_date.txt'
OUTPUT_FILE = 'output.txt'

with open(CVE_FILE) as f:
    cve_tuples = f.readlines()

with open(MALWARE_FILE) as f:
    malware_tuples = f.readlines()

cve_time_s = set()
cve_time = []
malware_time = []
slope_avgs = []

print 'constructing cve_time_s ...'
for i in cve_tuples:
    cve_time_s.add(int(i.split()[1]))

print 'constructing cve_time'
for i in cve_time_s:
    # trim down the list
    if i < 20160500:
        cve_time.append(i)

print 'sorting cve_time'
cve_time.sort()

print 'constructing malware_time ...'
for i in malware_tuples:
    try:
        malware_time.append(int(i.split()[1]))
    except IndexError:
        print 'wrong input format at line: ', len(malware_time)+1

print 'malware_time size: ', len(malware_time)
print 'sorting malware_time'
malware_time.sort()

for cve in cve_time:
    count = 0
    current_time = 0
    init = True
    counts = []
    day_intervals = []
    slopes = []
    for mal in malware_time:
        if mal > 20160500 or mal > calibrate_time(cve + 300):
            break
        else:
            if mal >= cve:
                if init:
                    init = False
                    current_time = mal
                if mal == current_time:
                    count += 1
                if mal > current_time:
                    day_intervals.append(mal - current_time)
                    counts.append(count)
                    count = 1
                    current_time = mal
    for i in range(0, len(counts)-1):
        diff = counts[i+1] - counts[i]
        slope = float(diff) / day_intervals[i]
        slopes.append(slope)
    slope_avg = numpy.mean(slopes)
    slope_avgs.append(slope_avg)
    print '============='
    print 'cve time: ', cve
    print 'mal counts: ', counts
    print 'day intervals: ', day_intervals
    print 'slopes: ', slopes
    print 'slope avg: ', slope_avg

print 'writing the output file ...'
output_file = open(OUTPUT_FILE, 'w+')
for idx, cve in enumerate(cve_time):
    line = str(cve) + ' ' + str(slope_avgs[idx]) + '\n'
    output_file.write(line)
output_file.close()
