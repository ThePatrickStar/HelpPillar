from matplotlib.pyplot import *
from numpy import *
from scipy.interpolate import *
from util import calibrate_time
import operator

COMBINED_FILE = 'malware_family_date.txt'
OUTPUT_MALWARE_NUM_TIME = 'malware_family_num_date.txt'

all_data = []

print 'constructing all_data_tuples ...'
with open(COMBINED_FILE) as f:
    all_data_tuples = f.readlines()

# for all_data: 0 is sha; 1 is date; 2 is family
print 'constructing all_data ...'
for i in all_data_tuples:
    all_data.append(i.split())

# sort according to item 1 (date)
print 'sorting all_data ...'
all_data = sorted(all_data, key=operator.itemgetter(1))


current_time = 20080800
times = []
family_set = set()
counts = []
for data in all_data:
    # sha = data[0]
    date = int(data[1])
    family = data[2]
    if date > 20151231:
        break
    elif date < 20080800:
        continue
    else:
        if date <= calibrate_time(current_time + 100):
            family_set.add(family)
        if date > calibrate_time(current_time + 100):
            counts.append(len(family_set))
            family_set.clear()
            current_time = calibrate_time(current_time + 100)

print 'writing the output_malware_time file ...'
output_file = open(OUTPUT_MALWARE_NUM_TIME, 'w+')

for idx, count in enumerate(counts):
    times.append(idx+1)
    line = str(count) + '\n'
    output_file.write(line)

output_file.close()

x = array(times)
y = array(counts)

poly_reg = polyfit(x, y, 9)
print 'coefficients of the regression output: ', poly_reg

plot(x, y, 'o')
plot(x, polyval(poly_reg, x))

savefig('poly_reg_malware_family_month.png')


